# Stock Prediction Application

AI-powered stock analysis system using multiple ML models (LSTM, Prophet, Chronos) with parallel processing and Supabase integration.

## Features

- ğŸ¤– **Multiple ML Models**: LSTM, Prophet, Chronos-Bolt for time series prediction
- ğŸš€ **Parallel Processing**: 5 concurrent workers for faster analysis
- ğŸ“Š **Cross-Sectional Models**: TabNet, SFM, ADDModel for comparative analysis
- ğŸ’¾ **Supabase Database**: Cloud-based PostgreSQL storage
- ğŸ“ **Comprehensive Logging**: All operations logged to `logs/app.log`
- ğŸ”” **Multi-Channel Notifications**: Discord, Telegram, Email support
- ğŸŒ **Multi-Market Support**: Taiwan (TW50, TW100), US (S&P500, NASDAQ, DJI), Semiconductors (SOX)

## Requirements

- Python 3.11+
- Virtual environment (recommended)

## Installation

1. **Clone the repository**
```bash
cd /home/ec2-user/stock-underdog-ml
```

2. **Create and activate virtual environment**
```bash
python3.11 -m venv myenv
source myenv/bin/activate
```

3. **Install dependencies**
```bash
pip install -r requirements.txt
```

## Configuration

### Quick Start

1. **Copy the example environment file**
```bash
cp .env.example .env
```

2. **Edit `.env` with your credentials**

### Required Configuration

```bash
# Supabase (Required)
SUPABASE_URL=https://your-project-id.supabase.co
SUPABASE_SERVICE_KEY=your_service_role_key

# Model Flags (Choose which models to run)
USE_PROPHET=true
USE_CHRONOS=true
USE_CROSS=true
USE_TRANSFORMER=false  # Optional, slower
```

### Optional Notifications

```bash
# Discord
DISCORD_WEBHOOK_URL=your_webhook_url

# Telegram
TELEGRAM_BOT_TOKEN=your_bot_token
TELEGRAM_CHANNEL_ID=your_channel_id

***REMOVED***
SMTP_SERVER=smtp.gmail.com
SENDER_EMAIL=your_email@gmail.com
EMAIL_PASSWORD=your_app_password
TO_EMAILS=recipient@example.com
```

See [.env.example](.env.example) for all available options.

## Database Setup

1. **Create Supabase Project** at [supabase.com](https://supabase.com)

2. **Run SQL Schema** (in Supabase SQL Editor):
```sql
CREATE TABLE predictions (
    id bigint generated by default as identity primary key,
    created_at timestamp with time zone default timezone('utc'::text, now()) not null,
    index_name text,
    model_name text,
    ticker text,
    current_price numeric,
    predicted_price numeric,
    potential numeric,
    period text,
    timestamp timestamp with time zone
);
```

3. **Get Service Role Key** from Settings â†’ API â†’ Service Role Key

## Usage

### Basic Run
```bash
source myenv/bin/activate
python main.py
```

### Customize Indices
Edit `main.py` line ~208:
```python
selected_indices = ["å°ç£50", "å°ç£ä¸­å‹100", "SP500"]
```

Available indices:
- `"å°ç£50"` - Taiwan Top 50
- `"å°ç£ä¸­å‹100"` - Taiwan Mid-Cap 100
- `"SP500"` - S&P 500
- `"NASDAQ"` - NASDAQ 100
- `"è²»åŸåŠå°é«”"` - Philadelphia Semiconductor (SOX)
- `"é“ç“Š"` - Dow Jones Industrial

## Project Structure

```
stock-underdog-ml/
â”œâ”€â”€ main.py                 # Main entry point
â”œâ”€â”€ config.py              # Configuration management
â”œâ”€â”€ database.py            # Supabase integration
â”œâ”€â”€ data_loader.py         # Stock data fetching
â”œâ”€â”€ logger.py              # Logging configuration
â”œâ”€â”€ notifier.py            # Notification services
â”œâ”€â”€ parallel_processor.py  # Parallel stock processing
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ lstm.py           # LSTM model
â”‚   â”œâ”€â”€ transformer.py    # Transformer model
â”‚   â”œâ”€â”€ prophet_model.py  # Prophet model
â”‚   â”œâ”€â”€ chronos_model.py  # Chronos-Bolt model
â”‚   â””â”€â”€ cross_section.py  # Cross-sectional models
â”œâ”€â”€ logs/                 # Log files
â””â”€â”€ requirements.txt      # Python dependencies
```

## Models

### Time Series Models (Per Stock)
- **LSTM**: Deep learning recurrent neural network
- **Prophet**: Facebook's time series forecasting
- **Chronos-Bolt**: AutoGluon's foundation model

### Cross-Sectional Models (All Stocks)
- **TabNet**: Attention-based tabular model
- **SFM**: Qlib's Stock Forecasting Model
- **ADDModel**: Qlib's Attention-based model

## Output

Results are:
1. **Saved to Supabase** (`predictions` table)
2. **Sent to Discord/Telegram/Email** (if configured)
3. **Logged to** `logs/app.log`

### Output Format (All Channels)

All notifications now use a unified table format:

```
**æ¯æ—¥æ½›åŠ›è‚¡åˆ†æ**
é‹ç®—æ—¥æœŸå’Œæ™‚é–“: 2026-01-05 14:30:00

æŒ‡æ•¸: å°ç£50

ğŸ¥‡ å‰äº”å LSTM ğŸ§ 
è‚¡ç¥¨     ç¾åƒ¹      é æ¸¬åƒ¹     æ½›åŠ›
----------------------------------------
2357.TW    546.00    680.44   24.62%
3034.TW    363.00    424.97   17.07%
2912.TW    220.50    247.38   12.19%
2395.TW    289.50    318.99   10.19%
4938.TW     68.70     74.64    8.65%

ğŸ“‰ å¾Œäº”å LSTM ğŸ§ 
è‚¡ç¥¨     ç¾åƒ¹      é æ¸¬åƒ¹     æ½›åŠ›
----------------------------------------
3711.TW    263.50    220.82  -16.20%
2330.TW   1670.00   1425.55  -14.64%
...
```

## Performance

- **Parallel Processing**: 5 concurrent workers
- **Taiwan 50**: ~2-3 minutes for all models
- **S&P 500**: ~15-20 minutes (110 stocks)

## Troubleshooting

### Keras Compatibility Error
If you see `ValueError: Your currently installed version of Keras is Keras 3`:
```bash
pip install tf-keras
```

### Supabase Connection Error
1. Verify `SUPABASE_URL` and `SUPABASE_SERVICE_KEY` in `.env`
2. Check table exists in Supabase dashboard
3. Ensure service role key (not anon key) is used

### Data Download Issues
- Check internet connection
- Verify stock ticker format (e.g., `2330.TW` for Taiwan stocks)
- Some stocks may have insufficient historical data

## Development

### Run Tests
```bash
# Test Prophet and Chronos
python test_prophet_chronos.py

# Test Supabase connection
python test_service_key.py
```

### View Logs
```bash
tail -f logs/app.log
```

## License

MIT

## Author

David (tbdavid2019)

## Acknowledgments

- Yahoo Finance for stock data
- Supabase for database hosting
- AutoGluon, Prophet, TensorFlow for ML frameworks