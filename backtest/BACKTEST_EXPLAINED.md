# 回測系統原理說明

## 📅 時間軸與數據流程

### 實際案例說明

假設今天是 **2026/01/08**，我們來看一個完整的回測流程：

```
時間軸：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

2025/07/08          2025/10/08         2026/01/08         2026/07/08
   │                    │                  │                  │
   │ 預測 A             │ 預測 B           │ 今天             │ 預測 C 目標日
   │ (6mo後)            │ (6mo後)          │                  │
   ▼                    ▼                  ▼                  ▼
目標: 2026/01/08    目標: 2026/04/08   目標: 2026/07/08   目標: 2027/01/08
   ✅ 可驗證           ⏳ 還要等3個月      ❌ 還要等6個月      ❌ 還要等1年
```

## 🔍 回測腳本的工作流程

### 1. 找出可驗證的預測

```python
# backtest.py 會查詢：
SELECT * FROM predictions 
WHERE actual_price IS NULL  # 還沒驗證過
  AND timestamp < NOW() - interval '1 day'  # 至少1天前的預測
```

### 2. 計算目標日期

```python
# 根據預測期間計算目標日期
if period == '6mo':
    target_date = prediction_date + 6個月
    
# 例如：
# 預測日期：2025/07/08
# 目標日期：2026/01/08
```

### 3. 下載實際股價

```python
# 使用 yfinance 下載目標日期的股價
stock = yf.Ticker("2330.TW")
hist = stock.history(period='1y')

# 找到目標日期的收盤價
actual_price = hist.loc[target_date]['Close']
```

### 4. 計算準確度

```python
# 預測時記錄的資料：
current_price = 100    # 2025/07/08 的股價
predicted_price = 110  # 預測 6 個月後會是 110

# 回測時抓到的實際資料：
actual_price = 105     # 2026/01/08 的實際股價

# 計算誤差：
percentage_error = (110 - 105) / 105 * 100 = 4.76%
```

## 📊 您的問題解答

### Q: 假設數據有 1/3、1/4、1/5，回測是用 1/4、1/5、1/6 去比對嗎？

**A: 不完全是！正確流程是：**

```
1/3  執行 main.py → 產生預測
     記錄到資料庫：
     - timestamp: 2026/01/03
     - current_price: 100 (當天股價)
     - predicted_price: 110 (預測 6 個月後)
     - actual_price: NULL (還不知道)
     
     ↓ 等待 6 個月...
     
7/3  執行 backtest.py
     計算目標日期 = 1/3 + 6個月 = 7/3
     用 yfinance 下載 7/3 的股價 = 105
     更新資料庫：
     - actual_price: 105
     - percentage_error: 4.76%
```

**關鍵點：**
- 預測時只記錄「當天股價」和「預測值」
- 回測時才去抓「目標日期的實際股價」
- **不是**每天都去比對，而是等到「預測日期 + 期間」才驗證

## ⏰ 為何一週跑一次就好？

### 原因分析：

1. **預測是長期的（6個月）**
   - 每天的股價波動對 6 個月後的預測影響很小
   - 不需要每天驗證

2. **批次處理更有效率**
   ```
   週日執行一次回測：
   - 檢查過去 7 天內到期的所有預測
   - 一次性下載所有需要的股價資料
   - 批次更新資料庫
   ```

3. **避免 API 限制**
   - yfinance 有請求頻率限制
   - 一週一次可以避免被封鎖

4. **數據已經足夠**
   ```
   假設每天產生 50 個預測：
   - 6 個月後 = 180 天後才驗證
   - 每週驗證一次 = 每次驗證約 350 個預測
   - 足夠評估模型表現
   ```

## 📈 實際範例

```
今天是 2026/01/08，執行 backtest.py：

找到 3 筆可驗證的預測：
┌─────────┬──────────────┬─────────────┬───────────────┬──────────────┐
│ Ticker  │ 預測日期     │ 目標日期    │ 預測價格      │ 實際價格     │
├─────────┼──────────────┼─────────────┼───────────────┼──────────────┤
│ 2330.TW │ 2025/07/08   │ 2026/01/08  │ 1700 → 1800   │ 1750 ✅      │
│ AAPL    │ 2025/07/05   │ 2026/01/05  │ 180 → 200     │ 195 ✅       │
│ TSLA    │ 2025/07/10   │ 2026/01/10  │ 250 → 300     │ 還沒到 ⏳   │
└─────────┴──────────────┴─────────────┴───────────────┴──────────────┘

結果：
- 2330.TW: 誤差 2.86% ✅
- AAPL: 誤差 2.56% ✅
- TSLA: 跳過（目標日期還沒到）
```

## 🎯 總結

- **預測** = 記錄「現在」和「預期未來」
- **回測** = 等到「未來」變成「現在」，再去驗證
- **頻率** = 一週一次足夠，因為預測是長期的
- **目的** = 評估模型準確度，持續改進
